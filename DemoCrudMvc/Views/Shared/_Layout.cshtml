@using Microsoft.AspNetCore.Http

@{
    var email = Context.Session.GetString("email");
    var count = Context.Session.GetInt32("CurrentCart");
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - DemoCrudMvc</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <link rel="stylesheet" href="~/DemoCrudMvc.styles.css" asp-append-version="true" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
          rel="stylesheet">
</head>
<body class="bg-light">
    <div id="loader">
        <div class="spinner-border text-info" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    <div class="">
        <nav class="navbar navbar-expand-sm navbar-light" id="neubar">
            <div class="container">
                @if (ViewData["Title"] as string != "TrackOrder")
                {
                    <a class="fs-3 nav-link" asp-action="Index" asp-controller="Home">Product Management </a>

                    <div class=" collapse navbar-collapse" id="navbarNavDropdown">
                        <ul class="navbar-nav ms-auto ">


                            @if (email == null)
                            {
                                <li class="nav-item fs-5">
                                    <a class="nav-link" asp-action="Index" asp-controller="Login">Login</a>
                                </li>
                            }
                            @if (email != null)
                            {

                                <li class="nav-item  fs-5">
                                    <a class="navbar-brand mx-2" asp-action="Product" asp-controller="Home">Products</a>
                                </li>
                            }
                            @if (email != null)
                            {

                                <li class="nav-item  fs-5">
                                    <a class="navbar-brand mx-2" asp-action="Index" asp-controller="Category">Category</a>
                                </li>
                            }
                            @if (email != null)
                            {
                                <li class="nav-item fs-5">
                                    <a class="navbar-brand mx-3" asp-action="LogOut" asp-controller="Login">Logout</a>
                                </li>
                            }
                            @if (email == null)
                            {
                                <li class="nav-item fs-5">
                                    <a class="navbar-brand mx-3" asp-action="AddToCart" asp-controller="Home">
                                        <i class="bi bi-cart fs-3"></i>
                                        <span id="cartCount" class="cart-count"></span>
                                    </a>
                                </li>
                                <li class="dropdown">
                                    <a class="dropdown-toggle" data-toggle="dropdown"> Notifiction (<span id="countNotify">0</span>) <span class="caret"></span></a>
                                    <ul class="dropdown-menu" id="myNotifyList">
                                    </ul>
                                </li>
                            }
                            @if (email != null)
                            {
                                <li class="nav-item fs-5">
                                    <a class="navbar-brand mx-3" asp-action="Index" asp-controller="Order">
                                        Order
                                    </a>
                                </li>
                            }

                        </ul>

                    </div>
                }
                else
                {
                    <a class="fs-3 nav-link" asp-action="Index" asp-controller="Home">Product Management   </a>
                }

            </div>
            </nav>
            <main role="main" class="pb-3">
                        @RenderBody()
            </main>
        </div>
    <div class="modal fade" id="myModal" role="dialog">
        <div class="modal-dialog">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        ×
                    </button>
                    <h4 class="modal-title">
                        <img src="assets/img/nty.png" style="height: 50px; width: 50px">
                        Notifications
                    </h4>
                </div>
                <div class="modal-body" id="myAllNotifications">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
        <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

        <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
        <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" integrity="sha512-dPXYcDub/aeb08c63jRq/k6GaKccl256JQy/AnOq7CAnEZ9FzSL9wSbcZkMp4R26vBsMLFYH4kQ67/bbV8XaCQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        <script src="~/lib/jquery/dist/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
        <script src="~/js/site.js" asp-append-version="true"></script>
                    @await RenderSectionAsync("Scripts", required: false)
        <script>


            $(window).on('ready', function () {
                console.log("hiilo")
                $('#loader').fadeIn();
            });

            $(window).on('load', function () {
                console.log("hii")
                $('#loader').fadeOut();
            });
            $(document).ajaxStart(function () {
                console.log("sdfs")
                $('#loader').fadeIn();
            });

            $(document).ajaxStop(function () {
                console.log("stop Ajax")
                $('#loader').fadeOut();
            });

        </script>
    </body>
    </html>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">   
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var products = JSON.parse(localStorage.getItem('cart'));
        var count = products ? Object.keys(products).length : 0;
        console.log(count)
            document.getElementById("cartCount").textContent = count;
        });
    </script>
<script>
    $(document).ready(function () {
        function fetchNotifications() {
            $.ajax({
                type: "GET",
                url: "/Home/GetNotificationData",
                success: function (data) {
                    console.log(data)
                    if (data.data == true) {
                        return
                    }
                    else {

                        let notifications = data.data.$values || [];
                        displayNotifications(notifications);
                    }
                },
                error: function () {
                    console.error('Error fetching notifications.');
                }
            });
        }

        function displayNotifications(notifications) {
            let index = 0;

            function showNextNotification() {
                if (index < notifications.length) {
                    let notification = notifications[index];
                    let message = `OrderProductId: ${notification.OrderProductId}, Customer: ${notification.Customer.FirstName} ${notification.Customer.LastName}, Order: ${formatTimeDifference(notification.OrderTime)}`;
                    toastr.info(message);
                    index++;
                    setTimeout(showNextNotification, 40000); // Show the next notification after 5 seconds
                } else {
                    // Restart the loop after all notifications are shown
                    setTimeout(() => {
                        index = 0;
                        showNextNotification();
                    }, 40000); // Wait 5 seconds before restarting
                }
            }

            function formatTimeDifference(timeDifference) {
                let [hours, minutes, seconds] = timeDifference.split(':');
                seconds = seconds.split('.')[0]; // Remove milliseconds
                console.log(seconds)
                hours = parseInt(hours, 10);
                minutes = parseInt(minutes, 10);
                seconds = parseInt(seconds, 10);
                return `${hours}h ${minutes}m ${seconds}s`;
            }
            showNextNotification();
        }

        // Initial fetch and display of notifications

        // Fetch notifications every 29 seconds
        setInterval(fetchNotifications, 2000000);
    });
</script>
<script>

</script>